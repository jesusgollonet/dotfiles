#!/bin/bash

# tmux
tmux_list_sessions(){
    tmux list-sessions | cut -d ":" -f1
}

tmux_get_session_from_ls(){
    local session_num
    session_num=$1
    tmux_list_sessions | sed -n "$session_num"p
}

tmux_go_to_session_num() {
    local session_num
    local session_name
    session_num=$1
    session_name=$(tmux_get_session_from_ls "$session_num");
    if [ -n "$TMUX" ]; 
    then 
        tmux switch -t "$session_name";
    else
        tmux attach -t "$session_name"
    fi; 
}

#sketch. Create a timestamp_name folder in ~/Temp
sketch(){
    local sketch_name
    local dir_name
    local tmp_dir
    if [ $# -eq 1 ]
    then
        sketch_name=_$1
    fi
    dir_name="$(date +"%Y-%m-%d_%H.%M.%S")$sketch_name" 

    tmp_dir=~/Sketch/"$dir_name"
    mkdir "$tmp_dir" && cd "$tmp_dir" && pwd
}

take(){
    local dir_name
    dir_name=$1
    mkdir -p "$dir_name" && cd "$dir_name" || exit
}

resn_clone(){
    local repo_name
    repo_name=$1
    git clone jesusgollonet@bitbucket.org:resn/"$repo_name".git
}

open_or_foreground_vim(){
    if jobs | grep -q "vim"; then 
        fg %?vi
    else 
        vi 
    fi
}
#zle -N open_or_foreground_vim
function gi() { 
    curl -sLw "\n" https://www.gitignore.io/api/$@ ;
}

## adding key commands to some zsh functions
function show_github_web(){
    gh repo view --web 
    zle reset-prompt
}

function list_github_issues(){
    gh issue list 
    echo # just adding a new line to prevent reset-prompt from eating output
    zle reset-prompt
}

function enter_lazygit(){
    lazygit
}

function notify(){
    local message
    message=$1
    terminal-notifier -message "$message" -title "TBD"
    curl -d "$message" ntfy.sh/rndjgbalert5
}

zle -N show_github_web
zle -N list_github_issues
zle -N enter_lazygit

tmux_project_session_name() {
    # Session naming: keep it stable and tmux-safe (alnum + underscores).
    local dir base
    dir="${1:-$PWD}"
    base="$(basename "$dir" | tr '[:upper:]' '[:lower:]')"
    echo "$base" | tr -cs '[:alnum:]' '-' | sed 's/^_//; s/_$//'
}

tmux_attach_or_switch() {
    local session_name="$1"
    if [ -n "$TMUX" ]; then
        tmux switch-client -t "$session_name"
    else
        tmux attach-session -t "$session_name"
    fi
}

# Enhanced tmux project session with optional .tmux.project config.
# If the session already exists, we just attach/switch.
tnn() {
    local session_name
    if ! command -v tmux >/dev/null 2>&1; then
        echo "tmux not found"
        return 127
    fi

    # Use provided name or fall back to directory name
    if [ -n "$1" ]; then
        session_name="$1"
    else
        session_name="$(tmux_project_session_name "$PWD")"
    fi

    if tmux has-session -t "$session_name" 2>/dev/null; then
        tmux_attach_or_switch "$session_name"
        return $?
    fi

    # Create new session with first window
    tmux new-session -d -s "$session_name" -c "$PWD" || return $?

    # Check for project-specific config
    if [ -f ".tmux.project" ]; then
        export TMUX_PROJECT_SESSION="$session_name"
        export TMUX_PROJECT_DIR="$PWD"
        echo "Using custom .tmux.project config"
        source .tmux.project
    else
        # Default layout: 2 windows, each with 2 panes
        tmux split-window -h -t "$session_name" -c "$PWD"
        tmux new-window -t "$session_name" -c "$PWD"
        tmux select-window -t "$session_name:1"
    fi

    tmux_attach_or_switch "$session_name"
}

# Jump to a project via zoxide, then attach/create its tmux session.
# Usage:
#   zt [query...]
#   zt            # interactive picker
zt() {
    local dir
    if ! command -v zoxide >/dev/null 2>&1; then
        echo "zoxide not found"
        return 127
    fi

    if [ "$#" -gt 0 ]; then
        dir="$(zoxide query -- "$@")" || return $?
    else
        dir="$(zoxide query -i)" || return $?
    fi

    cd "$dir" || return $?
    tnn
}

bindkey '^W' show_github_web
bindkey '^L' list_github_issues
bindkey '^G' enter_lazygit

# Git diff that auto-zooms tmux only when needed for wide output.
tmux_git_diff() {
    local tmp cols max_len zoomed pager
    tmp="$(mktemp /tmp/git-diff.XXXXXX)" || return 1
    cols="$(tput cols 2>/dev/null || echo 80)"

    # Capture diff once to avoid running twice.
    # Force color output (e.g. difftastic) even when redirected.
    DFT_COLOR=always GIT_PAGER=cat git -c color.ui=always diff > "$tmp"
    # Measure width without ANSI color codes.
    max_len="$(perl -pe 's/\x1b\[[0-9;]*m//g' "$tmp" | awk 'length>m{m=length} END{print m+0}')"

    if [ -n "$TMUX" ] && [ "$max_len" -gt "$cols" ]; then
        tmux resize-pane -Z
        zoomed=1
    fi

    pager="${PAGER:-less -R}"
    eval "$pager" < "$tmp"

    if [ -n "$zoomed" ]; then
        tmux resize-pane -Z
    fi

    rm -f "$tmp"
}
