#!/bin/bash

COLOURS="$HOME"/.dotfiles/tmux/config/colours

get_tmux_session_id() {
  tmux display-message -p '#{session_id}' | cut -d '$' -f2
}

set_background_colour() {
  local colour_number
  colour_number="$1"
  tmux set status-bg colour"$colour_number"
  tmux set status-fg colour0
}

get_colour_number() {
  local colour_index num_colours normalized_index
  colour_index="$1"
  num_colours=$(wc -l <"$COLOURS" | awk '{print $1}')
  normalized_index=$((1 + $((colour_index % num_colours))))
  sed "$normalized_index!d" "$COLOURS"
}

set_remote_indicator() {
  local session_id="$1"
  if [ -n "$SSH_CLIENT" ] || [ -n "$SSH_TTY" ] || [ -n "$MOSH_CONNECTION" ] || tmux show-environment -t "$session_id" 2>/dev/null | grep -qE "^(SSH_(CLIENT|TTY)|MOSH_CONNECTION)="; then
    tmux set -t "$session_id" status-left-length 50
    tmux set -t "$session_id" status-left "#[bg=colour196,fg=colour255,bold] REMOTE #[default] [#S] "
  fi
}

main() {
  local tmux_session_id colour_number
  tmux_session_id=$(get_tmux_session_id)
  colour_number=$(get_colour_number "$tmux_session_id")
  set_background_colour "$colour_number"
  set_remote_indicator "$tmux_session_id"
}

main
